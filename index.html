<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>File Trader — P2P</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <style>
    :root{
      --bg-a:#0b0b12; --bg-b:#14172a; --panel:rgba(24,22,36,.55); --panel-strong:rgba(24,22,36,.78);
      --stroke:rgba(255,255,255,.12); --ink:#f7f6f9; --muted:#b9b3c6; --accent:#9a88ff; --accent-2:#ff85d6;
      --good:#4ade80; --warn:#fbbf24; --bad:#fb7185; --radius:16px;
      --shadow: 0 12px 38px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1000px 600px at 10% 0%, #231a2d 0%, transparent 60%),
        radial-gradient(1000px 700px at 90% 10%, #172039 0%, transparent 60%),
        linear-gradient(160deg,var(--bg-a),var(--bg-b));
    }
    .container{max-width:1200px; margin:24px auto; padding:0 16px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:42px; height:42px; border-radius:12px; background:linear-gradient(145deg,var(--accent),var(--accent-2)); box-shadow:var(--shadow); display:grid; place-items:center}
    .brand h1{margin:0; font-size:18px; font-weight:800; letter-spacing:.3px}
    .bar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}

    .card{background:var(--panel); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px)}
    .panel{padding:16px}
    .pill{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke); background:var(--panel-strong)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:13px}

    button{cursor:pointer; border:1px solid var(--stroke); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--ink); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); transition: transform .12s ease, opacity .2s ease}
    button:hover{transform: translateY(-1px)}
    button:active{transform: translateY(0)}
    button.primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); border:none; color:#111; font-weight:800}
    button.ghost{background:transparent}
    button:disabled{opacity:.55; cursor:not-allowed}
    input[type=text]{background:rgba(255,255,255,.06); border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; color:var(--ink); outline:none; min-width:260px}

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    h2{margin:0 0 12px 0; font-size:15px; font-weight:800; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px}

    .drop{border:1px dashed var(--stroke); border-radius:14px; padding:18px; display:flex; align-items:center; justify-content:space-between; gap:12px; background:rgba(255,255,255,.03)}
    .drop input{display:none}

    .list{display:grid; gap:8px; max-height:360px; overflow:auto; padding-right:4px}
    .row{display:grid; grid-template-columns: 32px 1fr 100px 210px; gap:10px; align-items:center; padding:10px; border:1px solid var(--stroke); border-radius:12px; background:rgba(255,255,255,.02)}
    .icon{width:28px; height:28px; display:grid; place-items:center; border-radius:8px; background:rgba(255,255,255,.06)}
    .name{font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .size{color:var(--muted); font-size:12px}
    .actions{display:flex; gap:8px; justify-content:flex-end}

    .inbox{display:grid; gap:8px; max-height:196px; overflow:auto}
    .inbox .item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--stroke); border-radius:12px; background:rgba(255,255,255,.02)}
    .badge{font-size:11px; padding:6px 8px; border-radius:999px; border:1px solid var(--stroke); background:rgba(255,255,255,.04)}

    .trade .cols{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 760px){ .trade .cols{grid-template-columns:1fr} }
    .bucket{border:1px solid var(--stroke); border-radius:14px; padding:12px; background:rgba(255,255,255,.02)}
    .bucket h3{margin:0 0 8px 0; font-size:13px}
    .mini{display:grid; gap:8px; max-height:160px; overflow:auto}
    .minirow{display:grid; grid-template-columns: 1fr 110px; align-items:center; gap:8px; padding:8px; border:1px solid var(--stroke); border-radius:10px}

    .progress{height:8px; border-radius:999px; background:rgba(255,255,255,.06); overflow:hidden}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transition:width .2s ease}

    .status{display:flex; align-items:center; gap:8px}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--bad); box-shadow:0 0 0 4px rgba(251,113,133,.15); transition: all .3s ease}
    .dot.good{background:var(--good); box-shadow:0 0 0 6px rgba(74,222,128,.18)}

    .hint{font-size:12px; color:var(--muted)}
    .empty{padding:12px; text-align:center; color:var(--muted); border:1px dashed var(--stroke); border-radius:12px}

    .gate{display:grid; gap:12px; animation: floatIn .45s ease both}

    /* reveal-on-connect */
    .tradeArea{opacity:.2; filter:saturate(.5); pointer-events:none; transition: all .4s ease}
    body.connected .tradeArea{opacity:1; filter:none; pointer-events:auto}

    /* micro-animations */
    @keyframes floatIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
    @keyframes pulseGlow{0%{box-shadow:0 0 0 0 rgba(154,136,255,.4)} 100%{box-shadow:0 0 0 14px rgba(154,136,255,0)}}
    .pulse{animation: pulseGlow 1.2s ease-out 2}

    /* toast */
    .toast{position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:30}
    .toast .t{background:var(--panel-strong); border:1px solid var(--stroke); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); animation: floatIn .3s ease both}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="#111" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.77 5.82 22 7 14.15l-5-4.88 6.91-1.01L12 2z"/></svg>
        </div>
        <h1>File Trader</h1>
      </div>
      <div class="bar">
        <div class="pill" title="Your temporary ID (share to receive trades)"><span class="hint">Your Temp ID</span> <span id="myId" class="mono"></span> <button id="copyId">Copy</button></div>
        <div class="status"><span class="dot" id="statusDot"></span><span id="statusText" class="hint">Not connected</span></div>
      </div>
    </header>

    <!-- Connection gate -->
    <section class="card panel gate" id="connectCard">
      <h2>Connect to a Partner</h2>
      <div class="sub">Share your Temp ID with them, then enter their ID below and connect. Trading UI unlocks once connected.</div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <input id="partnerId" type="text" placeholder="Partner Temp ID" />
        <button id="btnConnect" class="primary pulse">Connect</button>
        <button id="btnDisconnect" class="ghost" disabled>Disconnect</button>
      </div>
    </section>

    <div class="grid tradeArea" id="tradeArea">
      <section class="panel card">
        <h2>Your Vault</h2>
        <div class="drop" id="drop">
          <div>
            <div style="font-weight:800">Upload files</div>
            <div class="sub">Drag & drop or choose files. They stay private until you trade.</div>
          </div>
          <div>
            <label>
              <input id="fileInput" type="file" multiple />
              <button>Choose files…</button>
            </label>
          </div>
        </div>
        <div class="list" id="vaultList"></div>
        <div class="empty" id="vaultEmpty">No files yet. Add some to your vault.</div>

        <div style="margin-top:18px; display:grid; gap:10px" class="card panel">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <button id="btnOffer" class="primary" disabled>Send Trade Offer</button>
            <span class="hint">Select files with “Offer”, then send.</span>
          </div>
          <div class="progress" title="Outgoing transfer progress"><div id="outProg"></div></div>
        </div>
      </section>

      <section class="panel card">
        <h2>Inbox & Active Trade</h2>
        <div class="panel card" style="margin-bottom:12px">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-weight:800">Inbox</div><span class="badge" id="inboxCount">0</span></div>
          <div class="inbox" id="inbox"></div>
          <div class="empty" id="inboxEmpty">No incoming trade offers yet.</div>
        </div>

        <div class="trade card panel">
          <div style="display:flex; align-items:center; justify-content:space-between">
            <div>
              <div style="font-weight:800">Active Trade</div>
              <div class="hint" id="tradeHint">No active trade.</div>
            </div>
            <div style="display:flex; gap:8px">
              <button id="btnAccept" disabled>Accept</button>
              <button id="btnFinalize" class="primary" disabled>Finalize & Exchange</button>
              <button id="btnCancel" class="ghost" disabled>Cancel</button>
            </div>
          </div>
          <div class="cols">
            <div class="bucket"><h3>Their Offer</h3><div id="theirOffer" class="mini"></div><div class="empty" id="theirOfferEmpty">Waiting for their selection…</div></div>
            <div class="bucket"><h3>Your Counter</h3><div id="yourCounter" class="mini"></div><div class="empty" id="yourCounterEmpty">Select files in your vault and toggle “Offer”.</div></div>
          </div>
          <div class="progress" title="Incoming transfer progress"><div id="inProg"></div></div>
          <div id="downloads" style="display:grid; gap:8px; margin-top:10px"></div>
        </div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const ui={
      connectCard:document.getElementById('connectCard'), tradeArea:document.getElementById('tradeArea'),
      myId:document.getElementById('myId'), copyId:document.getElementById('copyId'), statusDot:document.getElementById('statusDot'), statusText:document.getElementById('statusText'),
      partnerId:document.getElementById('partnerId'), btnConnect:document.getElementById('btnConnect'), btnDisconnect:document.getElementById('btnDisconnect'),
      drop:document.getElementById('drop'), input:document.getElementById('fileInput'), vaultList:document.getElementById('vaultList'), vaultEmpty:document.getElementById('vaultEmpty'),
      btnOffer:document.getElementById('btnOffer'), inbox:document.getElementById('inbox'), inboxEmpty:document.getElementById('inboxEmpty'), inboxCount:document.getElementById('inboxCount'),
      theirOffer:document.getElementById('theirOffer'), theirOfferEmpty:document.getElementById('theirOfferEmpty'), yourCounter:document.getElementById('yourCounter'), yourCounterEmpty:document.getElementById('yourCounterEmpty'),
      tradeHint:document.getElementById('tradeHint'), btnAccept:document.getElementById('btnAccept'), btnFinalize:document.getElementById('btnFinalize'), btnCancel:document.getElementById('btnCancel'),
      inProg:document.getElementById('inProg'), outProg:document.getElementById('outProg'), downloads:document.getElementById('downloads'), toast:document.getElementById('toast'),
    };

    const state={
      peer:null, conn:null, myId:null,
      inbox:[], vault:[], offers:new Set(), active:null,
      idb:null, currentRxId:null
    };

    const MAX_FILE_BYTES = 50*1024*1024; const CHUNK = 64*1024;

    function toast(msg){ const el=document.createElement('div'); el.className='t'; el.textContent=msg; ui.toast.appendChild(el); setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; setTimeout(()=>el.remove(),300); }, 2200); }

    function randId(){ const b=new Uint8Array(6); crypto.getRandomValues(b); return 'ft-'+Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join(''); }
    function fmtBytes(b){ const u=['B','KB','MB','GB']; let i=0; while(b>=1024&&i<u.length-1){b/=1024;i++} return b.toFixed(b<10&&i?1:0)+' '+u[i]; }

    // IndexedDB
    const DB='filetrader-v1';
    function idbOpen(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB,1); r.onupgradeneeded=()=>{ const db=r.result; if(!db.objectStoreNames.contains('files')) db.createObjectStore('files',{keyPath:'id'}); }; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
    function idbPut(rec){ return new Promise((res,rej)=>{ const tx=state.idb.transaction('files','readwrite'); tx.objectStore('files').put(rec); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    function idbAll(){ return new Promise((res,rej)=>{ const tx=state.idb.transaction('files','readonly'); const q=tx.objectStore('files').getAll(); q.onsuccess=()=>res(q.result||[]); q.onerror=()=>rej(q.error); }); }
    function idbGet(id){ return new Promise((res,rej)=>{ const tx=state.idb.transaction('files','readonly'); const q=tx.objectStore('files').get(id); q.onsuccess=()=>res(q.result||null); q.onerror=()=>rej(q.error); }); }
    function idbDel(id){ return new Promise((res,rej)=>{ const tx=state.idb.transaction('files','readwrite'); tx.objectStore('files').delete(id); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }

    function renderVault(){ ui.vaultList.innerHTML=''; if(state.vault.length===0){ ui.vaultEmpty.style.display='block'; } else { ui.vaultEmpty.style.display='none'; }
      state.vault.sort((a,b)=>b.ts-a.ts).forEach(file=>{ const row=document.createElement('div'); row.className='row'; const ext=(file.name.split('.').pop()||'').toUpperCase();
        row.innerHTML=`
          <div class="icon"><span class="mono">${ext.slice(0,3)||'BIN'}</span></div>
          <div class="name" title="${file.name}">${file.name}</div>
          <div class="size">${fmtBytes(file.size)}</div>
          <div class="actions">
            <button data-id="${file.id}" class="offerBtn">${state.offers.has(file.id)?'Offered':'Offer'}</button>
            <button data-dl="${file.id}">Download</button>
            <button data-del="${file.id}" class="ghost">Remove</button>
          </div>`; ui.vaultList.appendChild(row);
      });
      ui.vaultList.querySelectorAll('.offerBtn').forEach(b=>b.onclick=(e)=>{ const id=e.target.getAttribute('data-id'); if(state.offers.has(id)) state.offers.delete(id); else state.offers.add(id); renderVault(); renderCounter(); });
      ui.vaultList.querySelectorAll('button[data-dl]').forEach(b=>b.onclick=async(e)=>{ const id=e.target.getAttribute('data-dl'); const rec=await idbGet(id); if(!rec||!rec.data){ toast('Missing data'); return; } const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([rec.data],{type:rec.type})); a.download=rec.name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 3000); });
      ui.vaultList.querySelectorAll('button[data-del]').forEach(b=>b.onclick=async(e)=>{ const id=e.target.getAttribute('data-del'); await idbDel(id); state.vault=state.vault.filter(v=>v.id!==id); state.offers.delete(id); renderVault(); renderCounter(); });
    }

    function renderInbox(){ ui.inbox.innerHTML=''; ui.inboxCount.textContent=String(state.inbox.length); if(state.inbox.length===0){ ui.inboxEmpty.style.display='block'; return; } ui.inboxEmpty.style.display='none';
      state.inbox.forEach(item=>{ const el=document.createElement('div'); el.className='item'; const total=item.offer.reduce((a,f)=>a+f.size,0);
        el.innerHTML=`<div style="display:flex; gap:10px; align-items:center"><span class="badge">From</span><span class="mono">${item.partnerId}</span><span class="hint">${item.offer.length} files • ${fmtBytes(total)}</span></div>
        <div style="display:flex; gap:8px"><button data-view="${item.id}">Review</button><button data-ignore="${item.id}" class="ghost">Ignore</button></div>`;
        ui.inbox.appendChild(el);
      });
      ui.inbox.querySelectorAll('button[data-view]').forEach(b=>b.onclick=(e)=>{ const id=e.target.getAttribute('data-view'); const item=state.inbox.find(x=>x.id===id); if(!item) return; openTrade(item.partnerId,item.offer,id); state.inbox=state.inbox.filter(x=>x.id!==id); renderInbox(); });
      ui.inbox.querySelectorAll('button[data-ignore]').forEach(b=>b.onclick=(e)=>{ const id=e.target.getAttribute('data-ignore'); state.inbox=state.inbox.filter(x=>x.id!==id); renderInbox(); });
    }

    function renderOffersList(container, files){ container.innerHTML=''; if(!files||files.length===0){ (container.id==='theirOffer'?ui.theirOfferEmpty:ui.yourCounterEmpty).style.display='block'; return; } (container.id==='theirOffer'?ui.theirOfferEmpty:ui.yourCounterEmpty).style.display='none';
      files.forEach(f=>{ const r=document.createElement('div'); r.className='minirow'; r.innerHTML=`<div class="name" title="${f.name}">${f.name}</div><div class="size" style="text-align:right">${fmtBytes(f.size)}</div>`; container.appendChild(r); });
    }

    function renderCounter(){ if(!state.active){ renderOffersList(ui.yourCounter, []); return; } const mine=state.vault.filter(v=>state.offers.has(v.id)).map(({id,name,size,type})=>({id,name,size,type})); state.active.yourOffer=mine.map(m=>m.id); renderOffersList(ui.yourCounter, mine); updateTradeHint(); }

    function updateTradeHint(){ if(!state.active){ ui.tradeHint.textContent='No active trade.'; ui.btnAccept.disabled=true; ui.btnCancel.disabled=true; ui.btnFinalize.disabled=true; return; } const a=state.active; const meSel=a.yourOffer&&a.yourOffer.length>0; const themSel=a.theirOffer&&a.theirOffer.length>0; ui.btnAccept.disabled=!(meSel&&themSel); ui.btnCancel.disabled=false; ui.btnFinalize.disabled=!(a.accepted&&a.accepted.me&&a.accepted.them); const text = a.accepted?.me? (a.accepted.them? 'Both accepted. Ready to exchange.' : 'You accepted. Waiting for them…') : 'Select your files and Accept to proceed.'; ui.tradeHint.textContent=text; }

    function openTrade(partnerId,theirOffer,inboxId){ state.active={ id: inboxId||('t-'+Math.random().toString(36).slice(2,10)), partnerId, theirOffer, yourOffer:[], accepted:{me:false,them:false}, received:{}, sent:{} }; renderOffersList(ui.theirOffer,theirOffer); renderCounter(); ui.btnAccept.disabled=true; ui.btnFinalize.disabled=true; ui.btnCancel.disabled=false; }

    // Copy ID
    ui.copyId.onclick=async()=>{ await navigator.clipboard.writeText(state.myId); ui.copyId.textContent='Copied'; setTimeout(()=>ui.copyId.textContent='Copy',1200); toast('ID copied'); };

    // Uploads
    ui.drop.addEventListener('dragover', e=>{e.preventDefault(); ui.drop.style.borderColor='rgba(255,255,255,.35)'});
    ui.drop.addEventListener('dragleave', e=>{ui.drop.style.borderColor='var(--stroke)'});
    ui.drop.addEventListener('drop', e=>{e.preventDefault(); ui.drop.style.borderColor='var(--stroke)'; handleFiles(e.dataTransfer.files)});
    ui.input.onchange=()=> handleFiles(ui.input.files);

    async function handleFiles(fileList){ const files=Array.from(fileList||[]); for(const f of files){ if(f.size>MAX_FILE_BYTES){ toast(`${f.name}: too large (>${fmtBytes(MAX_FILE_BYTES)})`); continue; } const buf=await f.arrayBuffer(); const rec={ id: crypto.randomUUID(), name:f.name, size:f.size, type:f.type||'application/octet-stream', ts:Date.now(), data:buf }; await idbPut(rec); state.vault.push({id:rec.id,name:rec.name,size:rec.size,type:rec.type,ts:rec.ts}); } renderVault(); renderCounter(); }

    // PeerJS — use cloud by omitting host/port/path (avoids the old peerjs.com/myapp pitfall)
    async function initPeer(){ state.myId = randId(); ui.myId.textContent=state.myId;
      state.peer = new Peer(state.myId, { debug:2, config:{ iceServers:[ {urls:'stun:stun.l.google.com:19302'}, {urls:'stun:stun.services.mozilla.com'} ] } });
      state.peer.on('open', ()=>{ ui.statusText.textContent='Ready'; });
      state.peer.on('error', err=>{ ui.statusText.textContent='Error: '+err.type; ui.statusDot.classList.remove('good'); toast('Peer error: '+err.type); console.error(err); });
      state.peer.on('disconnected', ()=>{ ui.statusText.textContent='Disconnected'; ui.statusDot.classList.remove('good'); document.body.classList.remove('connected'); ui.btnOffer.disabled=true; ui.btnDisconnect.disabled=true; });
      state.peer.on('connection', bindConn);
    }

    function bindConn(conn){ state.conn = conn; ui.statusText.textContent='Connected to '+conn.peer; ui.statusDot.classList.add('good'); document.body.classList.add('connected'); ui.btnOffer.disabled=false; ui.btnDisconnect.disabled=false; conn.on('open',()=>{ toast('Connected'); sendJson({type:'hello', id: state.myId, vault: state.vault.map(({id,name,size,type})=>({id,name,size,type}))}); }); conn.on('data', onData); conn.on('close', ()=>{ toast('Peer closed'); ui.statusText.textContent='Peer closed'; ui.statusDot.classList.remove('good'); document.body.classList.remove('connected'); ui.btnOffer.disabled=true; }); conn.on('error', e=>{ console.error('conn error',e); ui.statusText.textContent='Conn error'; ui.statusDot.classList.remove('good'); document.body.classList.remove('connected'); }); }

    function connectTo(id){ if(!state.peer){ toast('Peer not ready'); return; } const conn = state.peer.connect(id, {reliable:true}); bindConn(conn); }
    function sendJson(obj){ if(state.conn && state.conn.open){ state.conn.send(JSON.stringify(obj)); } }

    // Protocol
    async function onData(payload){ if(payload instanceof ArrayBuffer || payload instanceof Blob){ await handleBinary(payload); return; } let msg=payload; if(typeof payload==='string'){ try{ msg=JSON.parse(payload); }catch{ return; } }
      switch(msg.type){
        case 'hello': break;
        case 'trade_request': { const item={ id: msg.tradeId, partnerId: state.conn.peer, offer: msg.offer }; state.inbox.unshift(item); renderInbox(); toast('Incoming trade offer'); break; }
        case 'trade_accept': { if(!state.active) return; state.active.accepted.them=true; updateTradeHint(); break; }
        case 'trade_cancel': { if(!state.active) return; state.active=null; resetTradeUI(); toast('Trade cancelled by partner'); break; }
        case 'trade_counter_set': { if(!state.active) return; state.active.theirOffer=msg.offer; renderOffersList(ui.theirOffer,msg.offer); updateTradeHint(); break; }
        case 'trade_finalize': { if(!state.active) return; state.active.accepted.them=true; updateTradeHint(); if(state.active.accepted.me && state.active.accepted.them){ beginExchange(); } break; }
        case 'request_files': { if(!state.active) return; const ids=msg.ids||[]; for(const id of ids){ const rec=await idbGet(id); if(!rec){console.warn('missing',id); continue;} await sendFile(rec); } break; }
        case 'file_start': { if(!state.active) return; state.currentRxId = msg.id; state.active.received[msg.id] = { meta: msg, chunks:[], received:0, total: msg.size }; break; }
        case 'file_end': { if(!state.active) return; const r=state.active.received[msg.id]; if(!r) return; const blob=new Blob(r.chunks,{type:r.meta.type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=r.meta.name; a.textContent=`Download ${r.meta.name} (${fmtBytes(r.meta.size)})`; const row=document.createElement('div'); row.className='minirow'; row.appendChild(a); const s=document.createElement('div'); s.style.textAlign='right'; s.textContent='Received'; row.appendChild(s); ui.downloads.appendChild(row); setTimeout(()=>URL.revokeObjectURL(a.href), 5*60*1000); state.currentRxId=null; updateIncomingProgress(); break; }
      }
    }

    async function handleBinary(buf){ if(!(buf instanceof ArrayBuffer)) buf = await buf.arrayBuffer(); if(!state.active||!state.currentRxId) return; const r=state.active.received[state.currentRxId]; if(!r) return; r.chunks.push(buf); r.received += buf.byteLength; const pct = r.total? Math.min(100, Math.round((r.received/r.total)*100)) : 0; ui.inProg.style.width=pct+'%'; }

    function buildMyOfferMeta(){ return state.vault.filter(v=>state.offers.has(v.id)).map(({id,name,size,type})=>({id,name,size,type})); }

    ui.btnOffer.onclick = ()=>{ if(!state.conn||!state.conn.open){ toast('Connect to a partner first'); return; } sendJson({type:'trade_request', tradeId: 't-'+Math.random().toString(36).slice(2,10), offer: buildMyOfferMeta()}); openTrade(state.conn.peer, [], 'local-'+Math.random().toString(36).slice(2,6)); };

    ui.btnAccept.onclick = ()=>{ if(!state.active) return; state.active.accepted.me=true; updateTradeHint(); const mine=buildMyOfferMeta(); sendJson({type:'trade_counter_set', offer: mine}); sendJson({type:'trade_accept'}); };
    ui.btnFinalize.onclick = ()=>{ if(!state.active) return; if(!(state.active.accepted.me)) return; sendJson({type:'trade_finalize'}); if(state.active.accepted.them){ beginExchange(); } else { updateTradeHint(); } };
    ui.btnCancel.onclick = ()=>{ if(!state.active) return; sendJson({type:'trade_cancel'}); state.active=null; resetTradeUI(); };

    function resetTradeUI(){ ui.theirOffer.innerHTML=''; ui.yourCounter.innerHTML=''; ui.downloads.innerHTML=''; ui.theirOfferEmpty.style.display='block'; ui.yourCounterEmpty.style.display='block'; ui.inProg.style.width='0%'; ui.outProg.style.width='0%'; updateTradeHint(); }

    function beginExchange(){ if(!state.active) return; ui.btnFinalize.disabled=true; ui.btnAccept.disabled=true; ui.tradeHint.textContent='Exchanging files…'; const want=(state.active.theirOffer||[]).map(f=>f.id); sendJson({type:'request_files', ids: want}); }

    async function sendFile(rec){ sendJson({type:'file_start', id: rec.id, name: rec.name, size: rec.size, type: rec.type}); const total=rec.data?rec.data.byteLength:0; const buf=rec.data||(await idbGet(rec.id))?.data; if(!buf){ console.warn('No data for',rec.id); return; } let sent=0; for(let off=0; off<buf.byteLength; off+=CHUNK){ const chunk=buf.slice(off, Math.min(off+CHUNK, buf.byteLength)); state.conn.send(chunk); sent+=chunk.byteLength; updateOutgoingProgress(sent,total); await new Promise(r=>setTimeout(r,0)); } sendJson({type:'file_end', id: rec.id}); updateOutgoingProgress(total,total); }

    function updateIncomingProgress(){ if(!state.active) return; const want=(state.active.theirOffer||[]).length; const have=ui.downloads.querySelectorAll('.minirow').length; const pct = want? Math.min(100, Math.round((have/want)*100)) : 0; ui.inProg.style.width=pct+'%'; if(pct===100){ ui.tradeHint.textContent='Trade complete. Downloads ready below.'; toast('Trade complete'); } }
    function updateOutgoingProgress(done,total){ const pct = total? Math.round((done/total)*100) : 0; ui.outProg.style.width=pct+'%'; }

    // Connect / disconnect controls
    ui.btnConnect.onclick = ()=>{ const id=ui.partnerId.value.trim(); if(!id){ toast('Enter partner ID'); return; } connectTo(id); };
    ui.btnDisconnect.onclick = ()=>{ if(state.conn){ try{ state.conn.close(); }catch{} } };

    // Boot
    (async function(){ state.idb = await idbOpen(); const recs = await idbAll(); state.vault = recs.map(({id,name,size,type,ts})=>({id,name,size,type,ts})); renderVault(); renderInbox(); resetTradeUI(); await initPeer(); ui.statusDot.classList.toggle('good', !!state.peer); })();
  </script>
</body>
</html>
